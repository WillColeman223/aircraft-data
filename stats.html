<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FlightBank - Statistics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      text-align: center;
    }

    ul {
      list-style-type: none;
      margin: 0;
      padding: 0;
      background-color: #8B0000;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    ul li a {
      display: block;
      color: white;
      padding: 14px 16px;
      text-decoration: none;
    }

    ul li a:hover {
      background-color: #111111;
    }

    .menu-items {
      display: flex;
      gap: 0;
    }

    h1 { margin: 20px 0; }

    #chartsContainer {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 30px;
      max-width: 1200px;
      margin: 0 auto 30px auto;
    }

    .chartBox {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      flex: 1 1 400px;
      max-width: 600px;
    }

    #counterBox {
      background: white;
      padding: 20px;
      margin: 20px auto 60px auto;
      border-radius: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      width: 300px;
      font-size: 26px;
      font-weight: bold;
    }

    .btn {
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      margin: 5px;
    }

    .btn-add { background: #8B0000; color: white; }
    .btn-clear { background: #444; color: white; }
  </style>
</head>
<body>

<ul>
  <div class="menu-items">
    <li><a href="index.html">FlightBank</a></li>
    <li><a href="stats.html">Statistics</a></li>
    <li><a href="index.html">About</a></li>
    <li><a href="stats.html">Contribute</a></li>
  </div>
</ul>

<h1>FlightBank - Airlines Statistics</h1>

<div id="chartsContainer">

  <!-- CUSTOM PIE CHART -->
  <div class="chartBox">
    <h2>Airline Pie Chart</h2>

    <input 
      type="text" 
      id="airlineInput" 
      placeholder="Add airline prefix (e.g. RYR, BAW)"
      style="padding:10px; width:70%; font-size:16px; border-radius:8px; margin-bottom:15px;"
    >

    <button onclick="addAirline()" class="btn btn-add">Add Airline</button>
    <button onclick="clearAirlines()" class="btn btn-clear">Clear</button>

    <p id="selectedAirlinesText" style="margin-top:10px; font-weight:bold;">
      Default: Top 10 Airlines
    </p>

    <canvas id="airlinePieChart"></canvas>
  </div>

  <!-- TOP 10 BAR CHART -->
  <div class="chartBox">
    <h2>Top 10 Airlines (Bar Chart)</h2>
    <canvas id="airlineBarChart"></canvas>
  </div>

</div>

<!-- COUNTER -->
<div id="counterBox">
  Total Planes Counted: <span id="planeCounter">0</span>
</div>

<!-- AIRNAV -->
<div style="margin: 40px auto; max-width: 1200px; text-align: center;">
  <h2>Our own flight receiver:</h2>
  <iframe 
    src="https://www.airnavradar.com/stations/EXTRPI704101" 
    style="width:100%; height:800px; border:1px solid #ccc; border-radius:10px;"
    title="AirNavRadar Station EXTRPI704101">
  </iframe>
</div>

<script>
const FIREBASE_URL = "https://flightbank-31a09-default-rtdb.firebaseio.com/PlaneData.json";

let currentDisplayedTotal = 0;
let allCounts = {};
let selectedAirlines = [];
let pieChart = null;
let top10List = [];

function animateCounter(target) {
  const counter = document.getElementById("planeCounter");
  const duration = 800;
  const start = currentDisplayedTotal;
  const startTime = performance.now();

  function update(time) {
    const progress = Math.min((time - startTime) / duration, 1);
    const value = Math.floor(start + (target - start) * progress);
    counter.textContent = value;
    if (progress < 1) requestAnimationFrame(update);
  }

  requestAnimationFrame(update);
  currentDisplayedTotal = target;
}

function addAirline() {
  const input = document.getElementById("airlineInput");
  const prefix = input.value.toUpperCase().trim();

  if (!prefix) return;

  if (!allCounts[prefix]) {
    alert("Airline prefix not found in the database!");
    input.value = "";
    return;
  }

  if (!selectedAirlines.includes(prefix)) {
    selectedAirlines.push(prefix);
  }

  input.value = "";
  updatePieChart();
}

function clearAirlines() {
  selectedAirlines = [];
  updatePieChart();
}

function updateSelectedAirlinesText() {
  const box = document.getElementById("selectedAirlinesText");

  if (selectedAirlines.length === 0) {
    box.textContent = "";
  } else {
    box.textContent = "Showing: " + selectedAirlines.join(", ");
  }
}

function updatePieChart() {
  updateSelectedAirlinesText();

  if (pieChart) pieChart.destroy();

  let labels, values;

  if (selectedAirlines.length === 0) {
    // Default: top 10
    labels = top10List.map(e => e[0]);
    values = top10List.map(e => e[1]);
  } else {
    labels = selectedAirlines;
    values = labels.map(prefix => allCounts[prefix]);
  }

  const colors = labels.map(() => '#' + Math.floor(Math.random() * 16777215).toString(16));

  const ctx = document.getElementById('airlinePieChart').getContext('2d');
  pieChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels,
      datasets: [{
        label: "Airline Breakdown",
        data: values,
        backgroundColor: colors,
        borderColor: '#fff',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' },
        title: { display: true, text: 'Airline Distribution' }
      }
    }
  });
}

async function fetchAndRenderStats() {
  try {
    const response = await fetch(FIREBASE_URL);
    const data = await response.json();
    if (!data) return;

    // Counter
    const totalPlanes = Object.keys(data).length;
    animateCounter(totalPlanes);

    // Airline counting
    allCounts = {};
    Object.values(data).forEach(plane => {
      if (!plane.Callsign) return;
      const prefix = plane.Callsign.match(/^[A-Z]{2,3}/)?.[0] || "Other";
      allCounts[prefix] = (allCounts[prefix] || 0) + 1;
    });

    // Create top 10 list
    top10List = Object.entries(allCounts)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 10);

    // Default pie chart refresh
    updatePieChart();

    // BAR CHART (unchanged)
    const barLabels = top10List.map(e => e[0]);
    const barValues = top10List.map(e => e[1]);
    const barColors = barLabels.map(() => '#' + Math.floor(Math.random()*16777215).toString(16));

    const barCtx = document.getElementById('airlineBarChart').getContext('2d');
    new Chart(barCtx, {
      type: 'bar',
      data: {
        labels: barLabels,
        datasets: [{
          label: 'Number of Planes',
          data: barValues,
          backgroundColor: barColors
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          title: { display: true, text: 'Top 10 Airlines by Plane Count' }
        },
        scales: {
          y: { beginAtZero: true, ticks: { stepSize: 1 } }
        }
      }
    });

  } catch (err) {
    console.error("Error fetching plane data:", err);
  }
}

fetchAndRenderStats();
setInterval(fetchAndRenderStats, 30000);
</script>

</body>
</html>
