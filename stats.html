<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FlightBank - Statistics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      text-align: center;
    }

    ul {
      list-style-type: none;
      margin: 0;
      padding: 0;
      background-color: #8B0000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1;
    }

    ul li a {
      display: block;
      color: white;
      padding: 14px 16px;
      text-decoration: none;
    }

    ul li a:hover {
      background-color: #111111;
    }

    .menu-items {
      display: flex;
      gap: 0;
    }

    h1 { margin: 20px 0; }

    #chartsContainer {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 30px;
      max-width: 1200px;
      margin: 0 auto 30px auto;
    }

    .chartBox {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      flex: 1 1 400px;
      max-width: 600px;
    }

    /* Counter styling */
    #counterBox {
      background: white;
      padding: 20px;
      margin: 20px auto 60px auto;
      border-radius: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      width: 300px;
      font-size: 26px;
      font-weight: bold;
    }
  </style>
</head>
<body>
<ul>
  <div class="menu-items">
    <li><a href="index.html">FlightBank</a></li>
    <li><a href="stats.html">Statistics</a></li>
    <li><a href="index.html">About</a></li>
    <li><a href="stats.html">Contribute</a></li>
  </div>
</ul>

<h1>FlightBank - Airlines Statistics</h1>

<div id="chartsContainer">
  <div class="chartBox">
    <h2>All Airlines (Pie Chart)</h2>
    <canvas id="airlinePieChart"></canvas>
  </div>
  <div class="chartBox">
    <h2>Top 10 Airlines (Bar Chart)</h2>
    <canvas id="airlineBarChart"></canvas>
  </div>
</div>

<!-- âœ¨ Animated Counter -->
<div id="counterBox">
  Total Planes Counted: <span id="planeCounter">0</span>
</div>

<script>
const FIREBASE_URL = "https://flightbank-31a09-default-rtdb.firebaseio.com/PlaneData.json";

let currentDisplayedTotal = 0; // for animation

function animateCounter(target) {
  const counter = document.getElementById("planeCounter");
  const duration = 800; // 0.8 sec animation
  const start = currentDisplayedTotal;
  const startTime = performance.now();

  function update(time) {
    const progress = Math.min((time - startTime) / duration, 1);
    const value = Math.floor(start + (target - start) * progress);
    counter.textContent = value;

    if (progress < 1) requestAnimationFrame(update);
  }

  requestAnimationFrame(update);
  currentDisplayedTotal = target;
}

async function fetchAndRenderStats() {
  try {
    const response = await fetch(FIREBASE_URL);
    const data = await response.json();
    if (!data) return;

    // Update animated total counter
    const totalPlanes = Object.keys(data).length;
    animateCounter(totalPlanes);

    // Count airlines by callsign prefix
    const counts = {};
    Object.values(data).forEach(plane => {
      if (!plane.Callsign) return;
      const prefix = plane.Callsign.match(/^[A-Z]{2,3}/)?.[0] || "Other";
      counts[prefix] = (counts[prefix] || 0) + 1;
    });

    // --- Pie chart data ---
    const pieLabels = Object.keys(counts).sort();
    const pieValues = pieLabels.map(l => counts[l]);
    const pieColors = pieLabels.map(() => '#' + Math.floor(Math.random()*16777215).toString(16));

    const pieCtx = document.getElementById('airlinePieChart').getContext('2d');
    new Chart(pieCtx, {
      type: 'pie',
      data: {
        labels: pieLabels,
        datasets: [{
          label: 'Number of Planes',
          data: pieValues,
          backgroundColor: pieColors,
          borderColor: '#fff',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' },
          title: { display: true, text: 'Planes by Airline Prefix' }
        }
      }
    });

    // --- Bar chart data (top 10) ---
    const sortedAirlines = Object.entries(counts)
      .sort((a,b) => b[1] - a[1])
      .slice(0, 10);
    const barLabels = sortedAirlines.map(e => e[0]);
    const barValues = sortedAirlines.map(e => e[1]);
    const barColors = barLabels.map(() => '#' + Math.floor(Math.random()*16777215).toString(16));

    const barCtx = document.getElementById('airlineBarChart').getContext('2d');
    new Chart(barCtx, {
      type: 'bar',
      data: {
        labels: barLabels,
        datasets: [{
          label: 'Number of Planes',
          data: barValues,
          backgroundColor: barColors
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          title: { display: true, text: 'Top 10 Airlines by Plane Count' }
        },
        scales: {
          y: { beginAtZero: true, ticks: { stepSize: 1 } }
        }
      }
    });

  } catch (err) {
    console.error("Error fetching plane data:", err);
  }
}

fetchAndRenderStats();
setInterval(fetchAndRenderStats, 30000);
</script>
</body>
</html>

